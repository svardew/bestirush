name: test_winfixbuf with python issue

on:
  push:
    branches: ['acme']
  workflow_dispatch:

permissions:
  contents: read # to fetch code (actions/checkout)

jobs:
  test_winfixbuf:
    runs-on: ubuntu-22.04

    env:
      CONFIG: "--disable-gui --with-features=normal "

    strategy:
      fail-fast: false
      matrix:
        py2: [no, yes, dynamic]
        py3: [no, yes, dynamic]

    steps:
      - name: begin
        run: echo '--- v9.1.0152. +python +python3.'

      - name: Checkout repository from github
        if: true
        uses: actions/checkout@v4
        with:
          # repository: vim/vim
          repository: svardew/vim
          # ref: v9.1.0152
          ref: af7ae8160041e2d17c56945381e9370e7178e596
          path: .

      - name: install python and python3
        shell: bash {0}
        run: |
          PKGS=( \
            gettext \
            desktop-file-utils \
            libtool-bin \
            libncurses-dev \
            libxt-dev \
          )
          PKGS+=( \
            autoconf \
            gdb \
            lcov \
            libcanberra-dev \
            python2-dev \
            python3-dev \
            cscope \
            libsodium-dev \
            attr \
            libattr1-dev \
          )
          PKGS+=( \
            locate \
          )
          # sudo apt-get update && sudo apt-get upgrade && sudo apt-get install -y "${PKGS[@]}"
          sudo apt-get update && sudo apt-get install -y "${PKGS[@]}"
          # libpython2.so may not exist. search latest version 2.7
          # locate return 1 if not found. set shell without -e option (shell: bash {0})
          python3 --version
          which python3
          # locate libpython3.so
          python2 --version
          which python2
          # locate libpython2.7.so
          echo 'check python command is python 2 or 3?'
          ls -lagG $(which python)

      - name: configure, build, version check vim
        if: true
        run: |
          ./configure ${{ env.CONFIG }} --enable-pythoninterp=${{ matrix.py2 }} --enable-python3interp=${{ matrix.py3 }}
          make
          ./src/vim --version

      - name: run test_winfxbuf
        run: |
          cd ./src/testdir
          echo 'runtest test_winfixbuf with TEST_FILTER=python'
          LC_ALL=C VIMRUNTIME=../../runtime make test_winfixbuf.res TEST_FILTER=python
          echo '// cat messages. CheckFeature affect py2 relate command.'
          cat messages

      - name: run patched test_winfxbuf
        shell: bash {0}
        run: |
          cd src
          make testclean
          cd testdir
          touch patch-test_winfixbuf
          cat <<'HEREDOC' | sed 's/^:\ //' > patch-test_winfixbuf
          : --- test_winfixbuf.vim_orig
          : +++ test_winfixbuf.vim
          : @@ -2507 +2507 @@
          : -  python << EOF
          : +  pythonx << EOF
          : @@ -2516,2 +2516,2 @@
          : -    pydo test_winfixbuf_Test_python_pydo_set_buffer()
          : -  catch /Vim(pydo):vim.error: Vim:E1513: Cannot edit buffer. 'winfixbuf' is enabled/
          : +    pyxdo test_winfixbuf_Test_python_pydo_set_buffer()
          : +  catch /Vim(pyxdo):vim.error: Vim:E1513: Cannot edit buffer. 'winfixbuf' is enabled/
          : @@ -2547,2 +2547,2 @@
          : -    pyfile file.py
          : -  catch /Vim(pyfile):vim.error: Vim:E1513: Cannot edit buffer. 'winfixbuf' is enabled/
          : +    pyxfile file.py
          : +  catch /Vim(pyxfile):vim.error: Vim:E1513: Cannot edit buffer. 'winfixbuf' is enabled/
          : @@ -2575 +2575 @@
          : -    python << EOF
          : +    pythonx << EOF
          : @@ -2581 +2581 @@
          : -  catch /Vim(python):vim\.error: Vim:E1513: Cannot edit buffer. 'winfixbuf' is enabled/
          : +  catch /Vim(pythonx):vim\.error: Vim:E1513: Cannot edit buffer. 'winfixbuf' is enabled/
          HEREDOC
          patch test_winfixbuf.vim --input ./patch-test_winfixbuf
          echo 'runtest test_winfixbuf with TEST_FILTER=python # patched test file'
          LC_ALL=C VIMRUNTIME=../../runtime make test_winfixbuf.res TEST_FILTER=python
          echo '// cat messages. pathced test expect pass 3 Test_python_* .'
          cat messages

      - name: close
        if: true
        run: |
          echo '--- some test may fail, due to CheckFeature disable python.'
