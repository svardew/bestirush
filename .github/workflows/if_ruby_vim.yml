name: ruby33-and-vim

on:
  push:
    branches: ['acme']
  workflow_dispatch:

permissions:
  contents: read # to fetch code (actions/checkout)

jobs:
  testruby:
    runs-on: ubuntu-22.04

    steps:
      - name: begin
        run: echo '--- start [testruby] job. hello,,, ' $PWD


      - name: Checkout repository from github
        uses: actions/checkout@v4
        with:
          repository: svardew/vim
          # ref: v9.0.2138
          ref: fda700cb04612fe2f9301a9ba820309175decabf
          path: .

      - name: setup ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: ruby-3.3.0-rc1

      - name: check setup-ruby stat
        run: |
          echo '// ruby --version && which ruby'
          ruby -v
          which ruby
          echo '// digest/sha256 for "ruby" string'
          echo '// expect [b9138194ffe9e7c8bb6d79d1ed56259553d18d9cb60b66e3ba5aa2e5b078055a]'
          ruby -rdigest/sha2 -e 'puts Digest::SHA256.hexdigest(%q[ruby])'
          echo '// display Rbconfig::CONFIG'
          ruby -e 'pp RbConfig::CONFIG'

      - name: configure, build, version check vim
        run: |
          ./configure --enable-gui=no --with-features=normal --enable-rubyinterp=dynamic
          make
          ./src/vim --version

      - name: test vim
        run: |
          cd src/testdir
          make test_let.res
          echo '// cat messages.'
          cat messages
          echo '// cat test.log'
          cat test.log

      - name: test ruby on vim
        run: |
          echo '// 1. test fail for NoMethodError format'
          make testclean
          cd src/testdir
          make test_ruby.res TEST_FILTER=Test_ruby_Vim_buffer_get
          echo '// cat messages.'
          cat messages
          echo '// cat test_result.log'
          if [ -f test_result.log ]; then cat test_result.log ; fi
          echo '// 2. test fail for rb_ary_detransient'

      - name: close
        run: echo '--- close [testruby] job. bye,,,' $PWD

