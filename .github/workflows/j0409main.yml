name: Manage cache with caller/called workflow cooperation

on:
  push:
    branches: ['**']
  # workflow_dispatch:

# Cancels all previous workflow runs for pull requests that have not completed.
concurrency:
  # The concurrency group contains the workflow name and the branch name for
  # pull requests or the commit hash for any other events.
  group: ${{ github.workflow }}-${{ github.event_name == 'pull_request' && github.head_ref || github.sha }}
  cancel-in-progress: true

permissions:
  contents: read # to fetch code (actions/checkout)

jobs:
  restore-cache:
    runs-on: ubuntu-22.04
    permissions:
      actions: write
      contents: write
    steps:
      - name: keyfile, cachedir
        run: |
          # hashFiles('keyfile') for cachekey
          touch keyfile
          echo 1234 >> keyfile
          echo https://example.com/pool/a/as/asdf/asdfqwert.zip >> keyfile
          echo 6789 >> keyfile
          sed -i 's/$/\r/g' keyfile
          cat keyfile
          file keyfile
          #= # cache 3 dummy files
          #= test -d cachedir || mkdir cachedir
          #= echo 1234 >> cachedir/line1
          #= echo 'https://example.com/pool/a/as/asdf/asdfqwert.zip' >> cachedir/line2
          #= echo 6789 >> cachedir/line3
          test -d repocache || mkdir repocache
      - name: restore cache
        uses: actions/cache/restore@v4
        with:
          key: Kash-${{ hashFiles('keyfile') }}
          path: repocache
      - name: check repocache
        run: |
          echo '--- files in repocache ---'
          ls -1 repocache

  call-update-cache:
    needs: [restore-cache]
    # commit 26a176e694c88c014cec03c14f70915c26e3dedb
    # uses: ./.github/workflows/j0409sub.yml@26a176e694c88c014cec03c14f70915c26e3dedb
    # ^^^ [./.github/workflows/FILENAME] allowed only [caller/called] at same commit
    uses: svardew/dew/.github/workflows/j0409sub.yml@26a176e694c88c014cec03c14f70915c26e3dedb
    # ^^^ OWNER/REPO/.gi_/wor_/FILENAME@REF is better
    # runs-on: ubuntu-22.04
    # steps:
    #   - name: echo ver
    #     run: uname -a
    secrets: inherit
    # ^^^ pass sercerts to called workflow

  use-cache:
    needs: [verify-cache-and-save]
    runs-on: ubuntu-22.04
    steps:
     - name: echo now
       run: env


